pipeline {
  agent {
    label 'amrit-slave-node'
  }
    stages {
      stage('BUild Application'){
        steps {
          sh 'mvn -f jenkins/java-tomcat-sample/pom.xml clean package'
       }
       post {
        success {
          echo "we are archiving the artifact"
          archiveArtifacts artifacts: '**/*.war', followSymlinks: false
        }
       }
     }
    stage('CreateTomcatImage'){
       agent {
    label 'amrit-slave-node'
  }
       steps {
        copyArtifacts filter: '**/*.war', fingerprintArtifacts: true, projectName: env.JOB_NAME, selector: lastSuccessful()
        echo "buiding docker images"
        sh '''
        original_pwd=$(pwd -P)
        cd jenkins/java-tomcat-sample
        docker build -t localtomcatimg:$BUILD_NUMBER .
        cd $original_pwd
        sh '''
       }
     }
     stage('deploy in QA instance'){
        agent {
    label 'amrit-slave-node'
  }
       steps {
        echo "we are deploying the app"
        sh '''
        docker container stop localtomcatinstance || true
        docker container rm localtomcatinstance || true
        docker container run -itd --name localtomcatinstance -p 8085:8080 localtomcatimg:$BUILD_NUMBER
    
        sh '''
       }
     }
      stage('deploy in Stagig Instace'){
         agent {
    label 'builtin-node'
  }
       steps {
         timeout(time:2, unit:'MINUTES'){
           input message: 'Approve thre staging deployment'
         }
        echo "we are deploying the app staggin enviroment"
        sh '''
        docker container stop localstaging || true
        docker container rm localstaging || true
        docker container run -itd --name localstaging -p 8084:8080 localtomcatimg:$BUILD_NUMBER
    
        sh '''
       }
     }
      stage('deploy from compose'){
         agent {
    label 'amrit-slave-node'
  }
        steps {
          echo "we are deploying from compose"
          sh 'cd /var/lib/jenkins/workspace/maven-project-pipeline/jenkins/java-tomcat-sample/'
          sh 'docker compose up -d'
        }
      }
}
   post {
    always {
      mail to: 'shrestha.amrit94@gmail.com',
      subject: "Job '${JOB_NAME}' (${BUILD_NUMBER}) complete running",
      body: "please go to ${BUILD_URL} and verify the build"
    }
  }
}
 
